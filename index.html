<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Code Scanner App</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f7fa;
    }
    #reader {
      max-width: 400px;
      margin-bottom: 20px;
    }
    input, textarea, button, select {
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    ul { list-style: none; padding-left: 0; }
    li {
      background: #ecf0f1;
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>QR Code Scanner App</h1>
  
  <label for="camera-select">Select Camera:</label>
  <select id="camera-select"><option value="">Select a Camera</option></select>
  <div id="reader"></div>
  <div>QR Result: <span id="qr-result">None</span></div>

  <form id="data-form">
    <input type="hidden" id="scan-date" name="scanDate"/>
    <input type="text" id="qr-code" name="qrCode" placeholder="QR Code" readonly />
    <input type="text" name="origin" placeholder="Origin" required />
    <input type="text" name="destination" placeholder="Destination" required />
    <input type="text" name="needle" placeholder="Needle" />
    <input type="text" name="bobbin" placeholder="Bobbin" />
    <input type="text" name="housing" placeholder="Housing" />
    <input type="text" name="folder" placeholder="Folder" />
    <input type="text" name="sender" placeholder="Sender" />
    <input type="text" name="recipient" placeholder="Recipient" />
    <textarea name="notes" placeholder="Notes"></textarea>
    <button type="button" id="add-entry">Add Entry</button>
  </form>

  <h2>History</h2>
  <ul id="history-list"></ul>

  <button id="submit-all">Submit All</button>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    const qrResult = document.getElementById("qr-result");
    const qrInput = document.getElementById("qr-code");
    const scanDate = document.getElementById("scan-date");
    const form = document.getElementById("data-form");
    const historyList = document.getElementById("history-list");
    const addBtn = document.getElementById("add-entry");
    const submitBtn = document.getElementById("submit-all");
    const cameraSelect = document.getElementById("camera-select");

    let entries = [];

    async function startCamera() {
      const devices = await Html5Qrcode.getCameras();
      devices.forEach(device => {
        const option = document.createElement("option");
        option.value = device.id;
        option.textContent = device.label || "Camera " + device.id;
        cameraSelect.appendChild(option);
      });

      const selectedCameraId = cameraSelect.value || devices[0].id;
      await html5QrCode.start(
        { deviceId: { exact: selectedCameraId } },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          qrResult.textContent = decodedText;
          qrInput.value = decodedText;
          scanDate.value = new Date().toISOString();
        },
        (error) => {}
      );
    }

    cameraSelect.addEventListener("change", () => {
      html5QrCode.stop().then(startCamera);
    });

    startCamera();

    addBtn.addEventListener("click", () => {
      const data = Object.fromEntries(new FormData(form));
      if (!data.qrCode) return alert("Please scan a QR code first.");
      if (!data.origin || !data.destination) return alert("Origin and Destination are required.");
      entries.push(data);
      const li = document.createElement("li");
      li.textContent = `${data.scanDate} - ${data.qrCode}`;
      historyList.appendChild(li);
      form.reset();
      qrResult.textContent = "None";
    });

    submitBtn.addEventListener("click", async () => {
      if (!entries.length) return alert("No entries to submit.");
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      const formData = new URLSearchParams();
      entries.forEach((entry, i) => {
        for (let [key, value] of Object.entries(entry)) {
          formData.append(`entry_${i}_${key}`, value);
        }
      });

      try {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbwKrFOAGF7M9P479FkNwl1YrwKh1SbtGXJuwrAClNJJj_KrTpbwE2S8_89LVyGYRkOSiQ/exec",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formData.toString()
          }
        );

        const text = await response.text();
        if (text.includes("success")) {
          alert("Data submitted!");
          entries = [];
          historyList.innerHTML = "";
        } else {
          throw new Error("Server error: " + text);
        }
      } catch (err) {
        console.error(err);
        alert("Failed to submit: " + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit All";
      }
    });
  </script>
</body>
</html>
